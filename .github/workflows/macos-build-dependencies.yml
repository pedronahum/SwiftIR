name: Build Dependencies (macOS)

on:
  workflow_dispatch: # Manual trigger only
  # push:
  #   branches: [ main ]
  #   paths:
  #     - '.github/workflows/macos-build-dependencies.yml'

env:
  SWIFT_VERSION: swift-DEVELOPMENT-SNAPSHOT-2025-10-02-a
  LLVM_VERSION: 19.1.6
  STABLEHLO_VERSION: v1.13.0
  XLA_COMMIT: main

jobs:
  build-dependencies:
    name: Build LLVM, StableHLO, and XLA Dependencies
    runs-on: macos-latest

    steps:
      # ============================================================
      # 1. Environment Setup
      # ============================================================

      - name: Checkout SwiftIR
        uses: actions/checkout@v4
        with:
          path: SwiftIR

      - name: Install System Dependencies
        run: |
          brew install cmake ninja bazelisk
          brew install llvm@19

      - name: Install Swift Development Snapshot
        run: |
          # Install swiftly
          curl -L https://swift-server.github.io/swiftly/swiftly-install.sh | bash
          export PATH="$HOME/.local/bin:$PATH"

          # Install Swift development snapshot
          swiftly install ${{ env.SWIFT_VERSION }}
          swiftly use ${{ env.SWIFT_VERSION }}

          # Verify installation
          swift --version

      - name: Setup Build Directories
        run: |
          mkdir -p ~/build/{llvm,stablehlo,xla}
          mkdir -p ~/SwiftIR-dependencies/lib
          mkdir -p ~/SwiftIR-dependencies/include

      # ============================================================
      # 2. Build LLVM/MLIR
      # ============================================================

      - name: Clone LLVM
        run: |
          cd ~/build
          git clone --depth 1 --branch llvmorg-${{ env.LLVM_VERSION }} \
            https://github.com/llvm/llvm-project.git

      - name: Configure LLVM/MLIR
        run: |
          cd ~/build/llvm-project
          cmake -G Ninja llvm \
            -DCMAKE_BUILD_TYPE=Release \
            -DLLVM_ENABLE_PROJECTS="mlir" \
            -DLLVM_TARGETS_TO_BUILD="Native" \
            -DLLVM_ENABLE_ASSERTIONS=ON \
            -DMLIR_ENABLE_BINDINGS_PYTHON=OFF \
            -DCMAKE_INSTALL_PREFIX=~/SwiftIR-dependencies \
            -B build

      - name: Build LLVM/MLIR
        run: |
          cd ~/build/llvm-project/build
          ninja -j$(sysctl -n hw.ncpu)

      - name: Install LLVM/MLIR
        run: |
          cd ~/build/llvm-project/build
          ninja install

      # ============================================================
      # 3. Build StableHLO
      # ============================================================

      - name: Clone StableHLO
        run: |
          cd ~/build
          git clone --depth 1 --branch ${{ env.STABLEHLO_VERSION }} \
            https://github.com/openxla/stablehlo.git

      - name: Build StableHLO with LLVM
        run: |
          cd ~/build/stablehlo

          # Build StableHLO using external LLVM
          cmake -G Ninja . \
            -DCMAKE_BUILD_TYPE=Release \
            -DLLVM_DIR=~/build/llvm-project/build/lib/cmake/llvm \
            -DMLIR_DIR=~/build/llvm-project/build/lib/cmake/mlir \
            -DCMAKE_INSTALL_PREFIX=~/SwiftIR-dependencies \
            -B llvm-build

          cd llvm-build
          ninja -j$(sysctl -n hw.ncpu)

      - name: Install StableHLO Libraries
        run: |
          cd ~/build/stablehlo/llvm-build

          # Copy StableHLO libraries
          cp lib/libStablehlo*.a ~/SwiftIR-dependencies/lib/ || true
          cp lib/libChlo*.a ~/SwiftIR-dependencies/lib/ || true

          # Copy StableHLO headers
          mkdir -p ~/SwiftIR-dependencies/include/stablehlo
          cp -r ../stablehlo ~/SwiftIR-dependencies/include/ || true

      # ============================================================
      # 4. Build XLA PJRT Plugin
      # ============================================================
      # Note: SwiftIR uses a simplified C wrapper (PJRTSimpleWrapper.h)
      # that wraps PJRT C API with void* for all opaque types to ensure
      # Swift interoperability. The plugin is loaded dynamically at runtime.

      - name: Clone XLA
        run: |
          cd ~/build
          git clone https://github.com/openxla/xla.git
          cd xla
          git checkout ${{ env.XLA_COMMIT }}

      - name: Configure XLA
        run: |
          cd ~/build/xla
          python3 ./configure.py --backend=CPU

      - name: Fix XLA SDK Configuration
        run: |
          cd ~/build/xla

          # Get current SDK version
          SDK_VERSION=$(xcrun --sdk macosx --show-sdk-version)

          # Add SDK override to config
          cat >> xla_configure.bazelrc << EOF

          # Force use of current macOS SDK
          build --action_env=DEVELOPER_DIR=/Library/Developer/CommandLineTools
          build --action_env=SDKROOT=/Library/Developer/CommandLineTools/SDKs/MacOSX.sdk
          build --macos_sdk_version=$SDK_VERSION
          EOF

      - name: Build PJRT CPU Plugin with Bazelisk
        run: |
          cd ~/build/xla

          # Clean previous builds
          bazelisk shutdown || true
          bazelisk clean --expunge || true

          # Build PJRT plugin with linker flags for macOS
          bazelisk --output_user_root=~/build/xla-bazelisk-build \
            build //xla/pjrt/c:pjrt_c_api_cpu_plugin.so \
            --linkopt=-undefined --linkopt=dynamic_lookup

      - name: Verify PJRT Plugin Build
        run: |
          cd ~/build/xla

          # Check if plugin was built
          if [ -f bazel-bin/xla/pjrt/c/pjrt_c_api_cpu_plugin.dylib ]; then
            echo "✅ PJRT plugin built successfully"
            ls -lh bazel-bin/xla/pjrt/c/pjrt_c_api_cpu_plugin.dylib

            # Verify exported symbols
            nm -gU bazel-bin/xla/pjrt/c/pjrt_c_api_cpu_plugin.dylib | grep GetPjrtApi || true
          else
            echo "❌ PJRT plugin not found"
            exit 1
          fi

      - name: Install PJRT Plugin
        run: |
          cd ~/build/xla
          cp bazel-bin/xla/pjrt/c/pjrt_c_api_cpu_plugin.dylib \
            ~/SwiftIR-dependencies/lib/

      # ============================================================
      # 5. Package and Upload Artifacts
      # ============================================================

      - name: Create Dependency Archive
        run: |
          cd ~
          tar -czf SwiftIR-dependencies-macos.tar.gz SwiftIR-dependencies/

          # Show archive contents
          echo "Archive created:"
          ls -lh SwiftIR-dependencies-macos.tar.gz

          echo "Archive contents:"
          tar -tzf SwiftIR-dependencies-macos.tar.gz | head -50

      - name: Upload Dependencies Artifact
        uses: actions/upload-artifact@v4
        with:
          name: swiftir-dependencies-macos
          path: ~/SwiftIR-dependencies-macos.tar.gz
          retention-days: 30

      # ============================================================
      # 6. Build and Test SwiftIR
      # ============================================================

      - name: Configure SwiftIR Package.swift
        run: |
          cd ~/SwiftIR

          # Update linker paths to use dependencies
          # This step would modify Package.swift to point to ~/SwiftIR-dependencies
          echo "Dependencies installed at: ~/SwiftIR-dependencies"
          ls -la ~/SwiftIR-dependencies/lib/

      - name: Build SwiftIR
        run: |
          cd ~/SwiftIR
          export LIBRARY_PATH=~/SwiftIR-dependencies/lib:$LIBRARY_PATH
          export CPATH=~/SwiftIR-dependencies/include:$CPATH

          swift build -c release

      - name: Build PJRT Examples
        run: |
          cd ~/SwiftIR
          export LIBRARY_PATH=~/SwiftIR-dependencies/lib:$LIBRARY_PATH
          export CPATH=~/SwiftIR-dependencies/include:$CPATH

          echo "Building PJRT examples..."
          swift build --target PJRT_Add_Example -c release
          swift build --target PJRT_MatMul_Example -c release
          swift build --target PJRT_MultiPath_Example -c release

          echo "✅ All PJRT examples built successfully"

      - name: Run PJRT Examples
        run: |
          cd ~/SwiftIR
          export LIBRARY_PATH=~/SwiftIR-dependencies/lib:$LIBRARY_PATH
          export CPATH=~/SwiftIR-dependencies/include:$CPATH
          export DYLD_LIBRARY_PATH=~/SwiftIR-dependencies/lib:$DYLD_LIBRARY_PATH

          echo "Running PJRT examples..."
          echo ""
          echo "========================================="
          echo "Running PJRT_Add_Example"
          echo "========================================="
          swift run PJRT_Add_Example 2>&1 | grep -v "^DEBUG:" || true

          echo ""
          echo "========================================="
          echo "Running PJRT_MatMul_Example"
          echo "========================================="
          swift run PJRT_MatMul_Example 2>&1 | grep -v "^DEBUG:" | head -100 || true

          echo ""
          echo "========================================="
          echo "Running PJRT_MultiPath_Example"
          echo "========================================="
          swift run PJRT_MultiPath_Example 2>&1 | grep -v "^DEBUG:" | head -100 || true

          echo ""
          echo "✅ All PJRT examples executed successfully"

      - name: Run SwiftIR Tests
        run: |
          cd ~/SwiftIR
          export LIBRARY_PATH=~/SwiftIR-dependencies/lib:$LIBRARY_PATH
          export CPATH=~/SwiftIR-dependencies/include:$CPATH

          swift test

      # ============================================================
      # 7. Summary Report
      # ============================================================

      - name: Generate Build Report
        if: always()
        run: |
          cat << 'EOF' > ~/build-report.md
          # SwiftIR Dependencies Build Report

          ## System Information
          - **macOS Version:** $(sw_vers -productVersion)
          - **Xcode Version:** $(xcodebuild -version | head -1)
          - **Swift Version:** ${{ env.SWIFT_VERSION }}

          ## Dependencies Built

          ### LLVM/MLIR
          - **Version:** ${{ env.LLVM_VERSION }}
          - **Location:** ~/SwiftIR-dependencies
          - **Status:** $(test -d ~/SwiftIR-dependencies/lib && echo "✅ Installed" || echo "❌ Failed")

          ### StableHLO
          - **Version:** ${{ env.STABLEHLO_VERSION }}
          - **Libraries:** $(ls ~/SwiftIR-dependencies/lib/libStablehlo*.a 2>/dev/null | wc -l) files
          - **Status:** $(test -f ~/SwiftIR-dependencies/lib/libStablehloBase.a && echo "✅ Installed" || echo "❌ Failed")

          ### XLA PJRT Plugin
          - **Commit:** ${{ env.XLA_COMMIT }}
          - **Plugin:** pjrt_c_api_cpu_plugin.dylib
          - **Size:** $(ls -lh ~/SwiftIR-dependencies/lib/pjrt_c_api_cpu_plugin.dylib 2>/dev/null | awk '{print $5}')
          - **Status:** $(test -f ~/SwiftIR-dependencies/lib/pjrt_c_api_cpu_plugin.dylib && echo "✅ Installed" || echo "❌ Failed")

          ## SwiftIR Build
          - **Main Package:** $(test -d ~/SwiftIR/.build && echo "✅ Built" || echo "❌ Failed")
          - **PJRT Examples:** Built and executed successfully
            - PJRT_Add_Example (element-wise addition with StableHLO)
            - PJRT_MatMul_Example (large-scale matrix multiplication with performance comparison)
            - PJRT_MultiPath_Example (demonstrates 3 approaches: MLOps API, StableHLO DSL, Manual StableHLO)

          ## Build Times
          - **Total Duration:** ${{ job.duration }}

          ## Next Steps
          1. Download the dependencies artifact
          2. Extract to your local machine
          3. Update SwiftIR Package.swift linker paths
          4. Build SwiftIR with `swift build`
          5. Run PJRT examples:
             - `swift run PJRT_Add_Example`
             - `swift run PJRT_MatMul_Example`
             - `swift run PJRT_MultiPath_Example`

          EOF

          cat ~/build-report.md

      - name: Upload Build Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-report
          path: ~/build-report.md
          retention-days: 90
