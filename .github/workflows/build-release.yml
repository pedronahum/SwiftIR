name: Build and Release SwiftIR

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.0)'
        required: true
        default: '0.1.0'
      skip_tests:
        description: 'Skip running tests'
        type: boolean
        default: false

env:
  SWIFT_VERSION: main-snapshot-2025-11-03

jobs:
  # =============================================================
  # Build SwiftIR on Ubuntu (uses pre-built dependencies)
  # =============================================================
  build-linux:
    name: Build SwiftIR (Linux x86_64)
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Free Disk Space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        df -h

    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential cmake ninja-build git wget curl \
          clang-18 lld-18 \
          libc++-18-dev libc++abi-18-dev \
          libicu-dev libssl-dev libxml2-dev \
          libcurl4-openssl-dev libz-dev libzstd-dev \
          libncurses-dev zlib1g-dev

    - name: Install Swift
      run: |
        # Download Swift directly instead of using swiftly (Ubuntu 24.04 not supported by swiftly)
        SWIFT_URL="https://download.swift.org/development/ubuntu2204/swift-DEVELOPMENT-SNAPSHOT-2025-11-03-a/swift-DEVELOPMENT-SNAPSHOT-2025-11-03-a-ubuntu22.04.tar.gz"

        echo "Downloading Swift development snapshot..."
        curl -L "$SWIFT_URL" -o /tmp/swift.tar.gz

        echo "Extracting Swift..."
        sudo mkdir -p /opt/swift
        sudo tar xzf /tmp/swift.tar.gz -C /opt/swift --strip-components=1

        echo "Setting up PATH..."
        echo "/opt/swift/usr/bin" >> $GITHUB_PATH
        export PATH="/opt/swift/usr/bin:$PATH"

        # Verify installation
        swift --version

    # Download pre-built dependencies from artifact or release
    - name: Download SwiftIR Dependencies
      uses: dawidd6/action-download-artifact@v3
      with:
        workflow: ubuntu-build-dependencies.yml
        name: swiftir-dependencies-ubuntu
        path: /tmp/deps
      continue-on-error: true

    - name: Extract Dependencies
      run: |
        if [ -f "/tmp/deps/SwiftIR-dependencies-ubuntu.tar.gz" ]; then
          echo "Extracting dependencies from artifact..."
          sudo tar xzf /tmp/deps/SwiftIR-dependencies-ubuntu.tar.gz -C /opt
          echo "Dependencies extracted to /opt/swiftir-deps"
          ls -la /opt/swiftir-deps/lib/ | head -20
        else
          echo "Dependencies artifact not found."
          echo "Please run the 'Build Dependencies (Ubuntu)' workflow first."
          echo ""
          echo "Go to: Actions -> Build Dependencies (Ubuntu) -> Run workflow"
          exit 1
        fi

    - name: Setup Environment
      run: |
        # Create environment script
        sudo tee /etc/profile.d/swiftir.sh > /dev/null << 'EOF'
        export SWIFTIR_DEPS_DIR=/opt/swiftir-deps
        export LD_LIBRARY_PATH=/opt/swiftir-deps/lib:$LD_LIBRARY_PATH
        export LIBRARY_PATH=/opt/swiftir-deps/lib:$LIBRARY_PATH
        export CPATH=/opt/swiftir-deps/include:$CPATH
        export SWIFTIR_HOME=/opt/swiftir-deps
        EOF

        source /etc/profile.d/swiftir.sh
        echo "LD_LIBRARY_PATH=$LD_LIBRARY_PATH" >> $GITHUB_ENV
        echo "LIBRARY_PATH=$LIBRARY_PATH" >> $GITHUB_ENV
        echo "CPATH=$CPATH" >> $GITHUB_ENV
        echo "SWIFTIR_HOME=$SWIFTIR_HOME" >> $GITHUB_ENV

    - name: Build SwiftIR
      run: |
        export PATH="$HOME/.local/bin:$PATH"
        source /etc/profile.d/swiftir.sh
        swift build -c release

    - name: Run Tests
      if: ${{ !inputs.skip_tests }}
      run: |
        export PATH="$HOME/.local/bin:$PATH"
        source /etc/profile.d/swiftir.sh
        # Run SwiftIRRuntime tests (lightweight, no MLIR deps)
        swift test --filter SwiftIRRuntimeTests

    - name: Determine Version
      id: version
      run: |
        if [ "${{ github.event_name }}" == "push" ]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          VERSION=${{ github.event.inputs.version }}
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"

    - name: Package Runtime Release
      run: |
        export PATH="$HOME/.local/bin:$PATH"
        VERSION=${{ steps.version.outputs.version }}
        PACKAGE_NAME="SwiftIR-${VERSION}-linux-x86_64"

        mkdir -p ${PACKAGE_NAME}/{lib,include,bin,share}

        # Copy SwiftIR libraries
        echo "Copying SwiftIR libraries..."
        cp -v .build/release/*.so ${PACKAGE_NAME}/lib/ 2>/dev/null || true

        # Copy Swift modules
        echo "Copying Swift modules..."
        for module in SwiftIR SwiftIRCore SwiftIRTypes SwiftIRDialects SwiftIRBuilders SwiftIRXLA SwiftIRStableHLO SwiftIRRuntime; do
          if [ -d ".build/release/${module}.swiftmodule" ]; then
            cp -r .build/release/${module}.swiftmodule ${PACKAGE_NAME}/include/
          fi
        done

        # Copy essential runtime dependencies
        echo "Copying runtime dependencies..."
        cp -v /opt/swiftir-deps/lib/pjrt_c_api_cpu_plugin.so ${PACKAGE_NAME}/lib/ 2>/dev/null || true
        cp -v /opt/swiftir-deps/lib/libSwiftIRMLIR.so ${PACKAGE_NAME}/lib/ 2>/dev/null || true
        cp -v /opt/swiftir-deps/lib/libPJRTProtoHelper.so ${PACKAGE_NAME}/lib/ 2>/dev/null || true

        # Copy LLVM/MLIR runtime libraries (only .so files needed at runtime)
        for lib in LLVM MLIR; do
          find /opt/swiftir-deps/lib -name "lib${lib}*.so*" -exec cp -v {} ${PACKAGE_NAME}/lib/ \; 2>/dev/null || true
        done

        # Create environment setup script
        cat > ${PACKAGE_NAME}/setup.sh << 'SETUPEOF'
        #!/bin/bash
        # SwiftIR Environment Setup
        # Source this file: source /path/to/SwiftIR/setup.sh

        SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

        export SWIFTIR_HOME="$SCRIPT_DIR"
        export LD_LIBRARY_PATH="$SCRIPT_DIR/lib:$LD_LIBRARY_PATH"
        export LIBRARY_PATH="$SCRIPT_DIR/lib:$LIBRARY_PATH"

        echo "SwiftIR environment configured!"
        echo "  SWIFTIR_HOME=$SWIFTIR_HOME"
        SETUPEOF
        chmod +x ${PACKAGE_NAME}/setup.sh

        # Create installation script
        cat > ${PACKAGE_NAME}/install.sh << 'INSTALLEOF'
        #!/bin/bash
        set -e

        PREFIX="${1:-/opt/swiftir}"
        SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

        echo "Installing SwiftIR to ${PREFIX}..."

        # Create directories
        sudo mkdir -p "${PREFIX}"/{lib,include,bin,share}

        # Copy files
        sudo cp -r "${SCRIPT_DIR}/lib/"* "${PREFIX}/lib/"
        sudo cp -r "${SCRIPT_DIR}/include/"* "${PREFIX}/include/" 2>/dev/null || true

        # Create environment script
        sudo tee /etc/profile.d/swiftir.sh > /dev/null << ENVSCRIPT
        export SWIFTIR_HOME=${PREFIX}
        export LD_LIBRARY_PATH=${PREFIX}/lib:\$LD_LIBRARY_PATH
        export LIBRARY_PATH=${PREFIX}/lib:\$LIBRARY_PATH
        ENVSCRIPT

        # Update library cache
        sudo ldconfig 2>/dev/null || true

        echo ""
        echo "Installation complete!"
        echo "Run: source /etc/profile.d/swiftir.sh"
        echo "Or add to your shell profile for permanent setup."
        INSTALLEOF
        chmod +x ${PACKAGE_NAME}/install.sh

        # Create tarball
        tar -czvf ${PACKAGE_NAME}.tar.gz ${PACKAGE_NAME}/

        echo ""
        echo "========================================="
        echo "Runtime package created: ${PACKAGE_NAME}.tar.gz"
        echo "========================================="
        ls -lh ${PACKAGE_NAME}.tar.gz
        echo ""
        echo "Contents:"
        tar -tzf ${PACKAGE_NAME}.tar.gz | head -30

    - name: Package Development SDK
      run: |
        VERSION=${{ steps.version.outputs.version }}
        SDK_NAME="SwiftIR-SDK-${VERSION}-linux-x86_64"

        echo "Creating development SDK package..."
        mkdir -p ${SDK_NAME}

        # Copy the FULL swiftir-deps directory (headers, cmake configs, libraries)
        echo "Copying full dependencies..."
        cp -r /opt/swiftir-deps/* ${SDK_NAME}/

        # Create setup script for SDK
        cat > ${SDK_NAME}/setup-sdk.sh << 'SDKEOF'
        #!/bin/bash
        # SwiftIR SDK Environment Setup
        # Source this file: source /path/to/SwiftIR-SDK/setup-sdk.sh

        SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

        export SWIFTIR_DEPS_DIR="$SCRIPT_DIR"
        export SWIFTIR_HOME="$SCRIPT_DIR"
        export LD_LIBRARY_PATH="$SCRIPT_DIR/lib:$LD_LIBRARY_PATH"
        export LIBRARY_PATH="$SCRIPT_DIR/lib:$LIBRARY_PATH"
        export CPATH="$SCRIPT_DIR/include:$CPATH"
        export PATH="$SCRIPT_DIR/bin:$PATH"

        echo "SwiftIR SDK environment configured!"
        echo "  SWIFTIR_DEPS_DIR=$SWIFTIR_DEPS_DIR"
        echo "  LD_LIBRARY_PATH includes: $SCRIPT_DIR/lib"
        echo ""
        echo "You can now build SwiftIR with: swift build"
        SDKEOF
        chmod +x ${SDK_NAME}/setup-sdk.sh

        # Create README for SDK
        cat > ${SDK_NAME}/README-SDK.md << 'READMEEOF'
        # SwiftIR Development SDK

        This SDK contains everything needed to compile SwiftIR from source,
        including pre-built LLVM/MLIR, StableHLO, and XLA dependencies.

        ## Quick Start (Google Colab / Linux)

        1. Extract and setup:

            tar xzf SwiftIR-SDK-*-linux-x86_64.tar.gz
            cd SwiftIR-SDK-*
            source ./setup-sdk.sh

        2. Clone and build SwiftIR:

            git clone https://github.com/pedronahum/SwiftIR.git
            cd SwiftIR
            swift build

        3. Run examples:

            swift run RuntimeInfo
            swift run PJRT_Add_Example

        ## Contents

        - lib/ - Pre-built libraries (LLVM, MLIR, PJRT plugins, etc.)
        - include/ - Header files for compilation
        - lib/cmake/ - CMake configuration files
        - bin/ - LLVM/MLIR tools

        ## Environment Variables

        The setup-sdk.sh script sets:
        - SWIFTIR_DEPS_DIR - Points to this SDK directory
        - LD_LIBRARY_PATH - For runtime library loading
        - LIBRARY_PATH - For compile-time linking
        - CPATH - For header file discovery

        ## Requirements

        - Linux x86_64 (Ubuntu 22.04+ recommended)
        - Swift 6.0+ (development snapshot recommended)
        READMEEOF

        # Create tarball
        tar -czvf ${SDK_NAME}.tar.gz ${SDK_NAME}/

        echo ""
        echo "========================================="
        echo "SDK package created: ${SDK_NAME}.tar.gz"
        echo "========================================="
        ls -lh ${SDK_NAME}.tar.gz
        echo ""
        echo "SDK Contents summary:"
        echo "  Libraries: $(find ${SDK_NAME}/lib -name '*.so' -o -name '*.a' 2>/dev/null | wc -l) files"
        echo "  Headers: $(find ${SDK_NAME}/include -name '*.h' 2>/dev/null | wc -l) files"
        echo "  CMake configs: $(find ${SDK_NAME}/lib/cmake -name '*.cmake' 2>/dev/null | wc -l) files"

    - name: Create Package README
      run: |
        VERSION=${{ steps.version.outputs.version }}
        PACKAGE_NAME="SwiftIR-${VERSION}-linux-x86_64"

        # Extract the package to add README
        tar xzf ${PACKAGE_NAME}.tar.gz

        # Create README without backticks (use indentation for code)
        cat > ${PACKAGE_NAME}/README.md << 'READMEEOF'
        # SwiftIR Prebuilt Binary

        SwiftIR: Swift for Intermediate Representation - Hardware-accelerated differentiable computing.

        ## Quick Start (Google Colab)

        In a Python cell, download and setup SwiftIR:

            !curl -L https://github.com/pedronahum/SwiftIR/releases/latest/download/SwiftIR-linux-x86_64.tar.gz | tar xz -C /content
            !mv /content/SwiftIR-* /content/SwiftIR
            %env LD_LIBRARY_PATH=/content/SwiftIR/lib
            %env SWIFTIR_HOME=/content/SwiftIR

        Then with the swift-jupyter kernel:

            import SwiftIRRuntime

            // Check available accelerators
            RuntimeDetector.printInfo()

            // Auto-detect best accelerator
            let accelerator = RuntimeDetector.detect()
            print("Using: \(accelerator)")

        ## Local Installation

            # Option 1: Quick setup (no install)
            source ./setup.sh

            # Option 2: System-wide install
            sudo ./install.sh              # Install to /opt/swiftir
            sudo ./install.sh /usr/local   # Or custom prefix

        ## Contents

        - lib/ - Shared libraries (SwiftIR, MLIR, PJRT CPU plugin)
        - include/ - Swift modules
        - setup.sh - Environment setup script
        - install.sh - System installation script

        ## Accelerator Support

        - CPU: pjrt_c_api_cpu_plugin.so - Bundled and ready
        - GPU: xla_cuda_plugin.so - Install via pip install jax[cuda12]
        - TPU: libtpu.so - Pre-installed on TPU VMs

        ## Requirements

        - Linux x86_64 (Ubuntu 22.04+ recommended)
        - Swift 6.0+ runtime (for development)

        ## More Information

        - GitHub: https://github.com/pedronahum/SwiftIR
        - Documentation: See repository README
        READMEEOF

        # Re-create tarball with README
        rm ${PACKAGE_NAME}.tar.gz
        tar -czvf ${PACKAGE_NAME}.tar.gz ${PACKAGE_NAME}/

    - name: Upload Runtime Artifact
      uses: actions/upload-artifact@v4
      with:
        name: swiftir-linux-x86_64
        path: SwiftIR-${{ steps.version.outputs.version }}-linux-x86_64.tar.gz
        retention-days: 14

    - name: Upload SDK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: swiftir-sdk-linux-x86_64
        path: SwiftIR-SDK-${{ steps.version.outputs.version }}-linux-x86_64.tar.gz
        retention-days: 14

  # =============================================================
  # Test the runtime package
  # =============================================================
  test-package:
    name: Test Runtime Package (Ubuntu)
    needs: build-linux
    runs-on: ubuntu-24.04

    steps:
    - name: Install Swift
      run: |
        # Download Swift directly instead of using swiftly (Ubuntu 24.04 not supported by swiftly)
        SWIFT_URL="https://download.swift.org/development/ubuntu2204/swift-DEVELOPMENT-SNAPSHOT-2025-11-03-a/swift-DEVELOPMENT-SNAPSHOT-2025-11-03-a-ubuntu22.04.tar.gz"

        echo "Downloading Swift development snapshot..."
        curl -L "$SWIFT_URL" -o /tmp/swift.tar.gz

        echo "Extracting Swift..."
        sudo mkdir -p /opt/swift
        sudo tar xzf /tmp/swift.tar.gz -C /opt/swift --strip-components=1

        echo "Setting up PATH..."
        echo "/opt/swift/usr/bin" >> $GITHUB_PATH
        export PATH="/opt/swift/usr/bin:$PATH"

        # Verify installation
        swift --version

    - name: Download Artifact
      uses: actions/download-artifact@v4
      with:
        name: swiftir-linux-x86_64

    - name: Test Extraction and Setup
      run: |
        echo "Extracting package..."
        tar xzf SwiftIR-*-linux-x86_64.tar.gz

        # Find the extracted directory (handles versioned names)
        SWIFTIR_DIR=$(find . -maxdepth 1 -type d -name "SwiftIR-*" -not -name "SwiftIR-SDK-*" | head -1)
        echo "Found SwiftIR directory: $SWIFTIR_DIR"

        echo ""
        echo "Package contents:"
        ls -la "$SWIFTIR_DIR/"

        echo ""
        echo "Libraries:"
        ls -la "$SWIFTIR_DIR/lib/"

        echo ""
        echo "Setting up environment..."
        cd "$SWIFTIR_DIR"
        source ./setup.sh

        echo ""
        echo "Verifying CPU plugin..."
        if [ -f "lib/pjrt_c_api_cpu_plugin.so" ]; then
          echo "CPU PJRT plugin found"
        else
          echo "CPU PJRT plugin missing"
          exit 1
        fi

  # =============================================================
  # Test the SDK package (can compile SwiftIR from source)
  # =============================================================
  test-sdk:
    name: Test SDK Package (Ubuntu)
    needs: build-linux
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential cmake ninja-build git wget curl \
          clang-18 lld-18 \
          libc++-18-dev libc++abi-18-dev \
          libicu-dev libssl-dev libxml2-dev \
          libcurl4-openssl-dev libz-dev libzstd-dev \
          libncurses-dev zlib1g-dev

    - name: Install Swift
      run: |
        SWIFT_URL="https://download.swift.org/development/ubuntu2204/swift-DEVELOPMENT-SNAPSHOT-2025-11-03-a/swift-DEVELOPMENT-SNAPSHOT-2025-11-03-a-ubuntu22.04.tar.gz"

        echo "Downloading Swift development snapshot..."
        curl -L "$SWIFT_URL" -o /tmp/swift.tar.gz

        echo "Extracting Swift..."
        sudo mkdir -p /opt/swift
        sudo tar xzf /tmp/swift.tar.gz -C /opt/swift --strip-components=1

        echo "Setting up PATH..."
        echo "/opt/swift/usr/bin" >> $GITHUB_PATH
        export PATH="/opt/swift/usr/bin:$PATH"

        swift --version

    - name: Download SDK Artifact
      uses: actions/download-artifact@v4
      with:
        name: swiftir-sdk-linux-x86_64

    - name: Extract and Setup SDK
      run: |
        echo "Extracting SDK package..."
        tar xzf SwiftIR-SDK-*-linux-x86_64.tar.gz

        # Find the extracted SDK directory
        SDK_DIR=$(find . -maxdepth 1 -type d -name "SwiftIR-SDK-*" | head -1)
        echo "Found SDK directory: $SDK_DIR"

        echo ""
        echo "SDK contents:"
        ls -la "$SDK_DIR/"

        echo ""
        echo "SDK libraries count: $(find $SDK_DIR/lib -name '*.so' -o -name '*.a' 2>/dev/null | wc -l)"
        echo "SDK headers count: $(find $SDK_DIR/include -name '*.h' 2>/dev/null | wc -l)"
        echo "CMake configs: $(find $SDK_DIR/lib/cmake -name '*.cmake' 2>/dev/null | wc -l)"

        # Move SDK to /opt for consistent paths
        sudo mv "$SDK_DIR" /opt/swiftir-deps
        echo "SDK installed to /opt/swiftir-deps"

    - name: Build SwiftIR from Source
      run: |
        # Setup environment
        export SWIFTIR_DEPS_DIR=/opt/swiftir-deps
        export LD_LIBRARY_PATH=/opt/swiftir-deps/lib:$LD_LIBRARY_PATH
        export LIBRARY_PATH=/opt/swiftir-deps/lib:$LIBRARY_PATH
        export CPATH=/opt/swiftir-deps/include:$CPATH

        echo "Building SwiftIR..."
        swift build -c release

        echo ""
        echo "Build successful!"
        ls -la .build/release/*.so 2>/dev/null || echo "No .so files (expected on some configs)"

    - name: Run Example
      run: |
        export SWIFTIR_DEPS_DIR=/opt/swiftir-deps
        export LD_LIBRARY_PATH=/opt/swiftir-deps/lib:$LD_LIBRARY_PATH

        echo "Running RuntimeInfo example..."
        swift run -c release RuntimeInfo 2>&1 | head -30 || true

        echo ""
        echo "SDK test complete!"

  # =============================================================
  # Create GitHub Release
  # =============================================================
  release:
    name: Create Release
    needs: [build-linux, test-package, test-sdk]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    permissions:
      contents: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Prepare Release Assets
      run: |
        mkdir release-assets

        # Copy runtime package
        cp artifacts/swiftir-linux-x86_64/*.tar.gz release-assets/

        # Copy SDK package
        cp artifacts/swiftir-sdk-linux-x86_64/*.tar.gz release-assets/

        # Create version-agnostic names for "latest" downloads
        cd release-assets
        for f in SwiftIR-[0-9]*-linux-x86_64.tar.gz; do
          [ -f "$f" ] && cp "$f" SwiftIR-linux-x86_64.tar.gz
        done
        for f in SwiftIR-SDK-*-linux-x86_64.tar.gz; do
          [ -f "$f" ] && cp "$f" SwiftIR-SDK-linux-x86_64.tar.gz
        done

        echo "Release assets:"
        ls -la

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: release-assets/*.tar.gz
        generate_release_notes: true
        draft: false
        prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        body: |
          ## SwiftIR ${{ github.ref_name }}

          Swift for Intermediate Representation - Hardware-accelerated differentiable computing.

          ### Download Options

          | Package | Description | Size |
          |---------|-------------|------|
          | `SwiftIR-linux-x86_64.tar.gz` | Runtime only (pre-built binaries) | ~400MB |
          | `SwiftIR-SDK-linux-x86_64.tar.gz` | Full SDK (compile from source) | ~2GB |

          - **Runtime Package**: Use if you just want to run SwiftIR examples
          - **SDK Package**: Use if you want to compile SwiftIR from source (e.g., in Colab)

          ### Google Colab Setup (Compile from Source)

          **Cell 1** - Install Swift:

              !curl -sL https://raw.githubusercontent.com/philipturner/swift-colab/refs/heads/main/install_swift_colab.sh | bash -s -- "11-28-a" &> /dev/null
              # Select Runtime > Change runtime type > Swift (if available) or restart

          **Cell 2** - Download SDK and setup:

              !curl -L https://github.com/pedronahum/SwiftIR/releases/download/${{ github.ref_name }}/SwiftIR-SDK-linux-x86_64.tar.gz | tar xz -C /content
              !mv /content/SwiftIR-SDK-* /opt/swiftir-deps
              %env SWIFTIR_DEPS_DIR=/opt/swiftir-deps
              %env LD_LIBRARY_PATH=/opt/swiftir-deps/lib
              %env LIBRARY_PATH=/opt/swiftir-deps/lib
              %env CPATH=/opt/swiftir-deps/include

          **Cell 3** - Clone and build:

              !git clone https://github.com/pedronahum/SwiftIR.git /content/SwiftIR
              !cd /content/SwiftIR && swift build

          **Cell 4** - Run example:

              !cd /content/SwiftIR && swift run RuntimeInfo

          ### Local Linux Installation

              # Download SDK
              curl -LO https://github.com/pedronahum/SwiftIR/releases/download/${{ github.ref_name }}/SwiftIR-SDK-linux-x86_64.tar.gz
              tar xzf SwiftIR-SDK-linux-x86_64.tar.gz
              cd SwiftIR-SDK-*

              # Setup environment
              source ./setup-sdk.sh

              # Clone and build SwiftIR
              git clone https://github.com/pedronahum/SwiftIR.git
              cd SwiftIR
              swift build

              # Run examples
              swift run RuntimeInfo
              swift run PJRT_Add_Example

          ### What's Included in SDK

          - Pre-built LLVM/MLIR libraries
          - Pre-built StableHLO libraries
          - Pre-built XLA/PJRT libraries
          - CPU PJRT plugin (bundled)
          - All headers and CMake configs

          ### Accelerator Support

          - CPU: Ready (plugin bundled)
          - GPU: Install jax[cuda12] for CUDA plugin
          - TPU: Ready on TPU VMs/Colab TPU

          See the [full documentation](https://github.com/pedronahum/SwiftIR#readme) for more examples.
